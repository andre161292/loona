name: test

on:
  push:
    branches:
      - main
  pull_request:
  merge_group:

jobs:
  test-linux:
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0
    runs-on:
      - nscloud-ubuntu-22.04-amd64-32x64-with-cache
      - nscloud-cache-size-20gb
      - nscloud-cache-tag-fluke
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Setup cargo cache
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          path: |
            ./target
            ./target-cov
      - name: Install Rust specified toolchain
        run: |
          rm -rf ~/.rustup
          rustup show
      - uses: taiki-e/install-action@v2
        with:
          tool: just,cargo-nextest
      - name: Run unit tests and h2spec
        run: |
          cd ${{ github.workspace }}
          cargo clippy
          mkdir tools
          export PATH=$PATH:${PWD}/tools
          # (pushd tools && curl -L https://github.com/summerwind/h2spec/releases/download/v2.6.0/h2spec_linux_amd64.tar.gz | tar -xz && popd)
          # Uses https://github.com/summerwind/h2spec/pull/123, more precisely
          # https://github.com/fasterthanlime/h2spec/commit/72a6b9b2b01133d292bd74e019fde86c3638094a
          (pushd tools && curl -fL https://github.com/bearcove/h2spec-binaries/releases/download/72a6b9b/h2spec -o h2spec && chmod +x h2spec && popd)
          just ci-test
      - name: Upload coverage information
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
          verbose: true
          file: coverage/lcov.info
